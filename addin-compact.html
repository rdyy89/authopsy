<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Email Authentication Checker</title>

    <!-- Office JavaScript API -->
    <script type="text/javascript" src="https://appsforoffice.microsoft.com/lib/1.1/hosted/office.js"></script>

    <style>
        /* Compact add-in CSS */
        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #ffffff;
            font-size: 12px;
        }

        .addin-container {
            width: 100%;
            height: 100%;
            padding: 8px;
            box-sizing: border-box;
            overflow-y: auto;
        }

        .addin-header {
            text-align: center;
            padding: 8px 0;
            background-color: #f3f2f1;
            border-radius: 4px;
            margin-bottom: 8px;
        }

        .addin-header h1 {
            margin: 0;
            color: #323130;
            font-weight: 600;
            font-size: 14px;
        }

        .email-info {
            background-color: #f8f9fa;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #e1e5e9;
            margin-bottom: 8px;
        }

        .email-info h2 {
            font-size: 12px;
            font-weight: 600;
            margin: 0 0 4px 0;
            color: #323130;
        }

        .email-subject {
            font-weight: 600;
            color: #323130;
            margin-bottom: 2px;
            font-size: 11px;
        }

        .email-from {
            color: #605e5c;
            font-size: 10px;
        }

        .auth-results {
            background-color: #ffffff;
            border: 1px solid #e1e5e9;
            border-radius: 4px;
            padding: 8px;
            margin-bottom: 8px;
        }

        .auth-results h2 {
            margin: 0 0 8px 0;
            color: #323130;
            font-weight: 600;
            font-size: 12px;
        }

        .auth-check {
            margin-bottom: 8px;
            padding: 6px;
            border-radius: 3px;
            border: 1px solid #edebe9;
            background-color: #faf9f8;
        }

        .auth-check:last-child {
            margin-bottom: 0;
        }

        .auth-label {
            font-weight: 600;
            color: #323130;
            margin-bottom: 4px;
            font-size: 11px;
        }

        .auth-status {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-bottom: 4px;
        }

        .status-icon {
            font-size: 14px;
            width: 16px;
            text-align: center;
        }

        .status-text {
            font-weight: 500;
            font-size: 11px;
        }

        .auth-details {
            font-size: 9px;
            color: #605e5c;
            margin-top: 2px;
            line-height: 1.3;
        }

        .status-pass { color: #107c10; }
        .status-fail { color: #d13438; }
        .status-warning { color: #ff8c00; }
        .status-checking { color: #0078d4; }

        .overall-score {
            background-color: #f3f2f1;
            padding: 8px;
            border-radius: 4px;
            text-align: center;
            border: 1px solid #e1e5e9;
            margin-bottom: 8px;
        }

        .overall-score h3 {
            margin: 0 0 6px 0;
            color: #323130;
            font-size: 12px;
            font-weight: 600;
        }

        .score-display {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .score-number { color: #0078d4; }
        .score-total { color: #605e5c; font-size: 14px; }

        .recommendation {
            font-size: 9px;
            color: #605e5c;
            margin-top: 4px;
            font-style: italic;
        }

        .ms-Button {
            display: inline-block;
            text-decoration: none;
            text-align: center;
            cursor: pointer;
            padding: 6px 12px;
            border: 1px solid transparent;
            border-radius: 2px;
            font-size: 11px;
            font-weight: 400;
            min-width: 60px;
            background-color: transparent;
            color: #323130;
            outline: none;
            user-select: none;
            width: 100%;
        }

        .ms-Button--primary {
            background-color: #0078d4;
            border-color: #0078d4;
            color: #ffffff;
        }

        .ms-Button--primary:hover {
            background-color: #106ebe;
            border-color: #106ebe;
        }

        .ms-Button-label {
            display: block;
            font-weight: 600;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .status-checking .status-icon {
            animation: spin 1s linear infinite;
        }
    </style>
</head>

<body>
    <div class="addin-container">
        <header class="addin-header">
            <h1>Email Authentication</h1>
        </header>
        
        <div class="email-info">
            <h2>Current Email</h2>
            <div id="email-subject" class="email-subject">Loading...</div>
            <div id="email-from" class="email-from">Loading...</div>
        </div>
        
        <div class="auth-results">
            <h2>Authentication Results</h2>
            
            <div class="auth-check" id="spf-check">
                <div class="auth-label">SPF</div>
                <div class="auth-status" id="spf-status">
                    <span class="status-icon" id="spf-icon">⏳</span>
                    <span class="status-text" id="spf-text">Checking...</span>
                </div>
                <div class="auth-details" id="spf-details"></div>
            </div>
            
            <div class="auth-check" id="dkim-check">
                <div class="auth-label">DKIM</div>
                <div class="auth-status" id="dkim-status">
                    <span class="status-icon" id="dkim-icon">⏳</span>
                    <span class="status-text" id="dkim-text">Checking...</span>
                </div>
                <div class="auth-details" id="dkim-details"></div>
            </div>
            
            <div class="auth-check" id="dmarc-check">
                <div class="auth-label">DMARC</div>
                <div class="auth-status" id="dmarc-status">
                    <span class="status-icon" id="dmarc-icon">⏳</span>
                    <span class="status-text" id="dmarc-text">Checking...</span>
                </div>
                <div class="auth-details" id="dmarc-details"></div>
            </div>
        </div>
        
        <div class="overall-score">
            <h3>Security Score</h3>
            <div id="security-score" class="score-display">
                <span class="score-number" id="score-number">-</span>
                <span class="score-total">/100</span>
            </div>
            <div id="security-recommendation" class="recommendation"></div>
        </div>
        
        <button class="ms-Button ms-Button--primary" id="refresh-button">
            <span class="ms-Button-label">Refresh</span>
        </button>
    </div>

    <script type="text/javascript">
        // IE11 compatible JavaScript
        Office.onReady(function(info) {
            if (info.host === Office.HostType.Outlook) {
                document.getElementById("refresh-button").onclick = checkAuthentication;
                initializeAddin();
            }
        });

        function initializeAddin() {
            try {
                loadEmailInfo();
                checkAuthentication();
            } catch (error) {
                console.error("Error initializing add-in:", error);
                showError("Failed to initialize add-in");
            }
        }

        function loadEmailInfo() {
            Office.context.mailbox.item.subject.getAsync(function(result) {
                if (result.status === Office.AsyncResultStatus.Succeeded) {
                    document.getElementById("email-subject").textContent = result.value || "No Subject";
                } else {
                    document.getElementById("email-subject").textContent = "Unable to load subject";
                }
            });

            Office.context.mailbox.item.from.getAsync(function(result) {
                if (result.status === Office.AsyncResultStatus.Succeeded) {
                    var from = result.value;
                    var fromText = from ? (from.displayName || '') + ' <' + (from.emailAddress || '') + '>' : "Unknown sender";
                    document.getElementById("email-from").textContent = fromText;
                } else {
                    document.getElementById("email-from").textContent = "Unable to load sender";
                }
            });
        }

        function checkAuthentication() {
            resetAuthenticationUI();
            
            try {
                getEmailHeaders().then(function(headers) {
                    var spfResult = checkSPF(headers);
                    var dkimResult = checkDKIM(headers);
                    var dmarcResult = checkDMARC(headers);
                    
                    updateAuthenticationUI('spf', spfResult);
                    updateAuthenticationUI('dkim', dkimResult);
                    updateAuthenticationUI('dmarc', dmarcResult);
                    
                    var overallScore = calculateOverallScore(spfResult, dkimResult, dmarcResult);
                    updateOverallScore(overallScore);
                }).catch(function(error) {
                    console.error("Error checking authentication:", error);
                    showError("Failed to check email authentication");
                });
            } catch (error) {
                console.error("Error checking authentication:", error);
                showError("Failed to check email authentication");
            }
        }

        function getEmailHeaders() {
            return new Promise(function(resolve, reject) {
                if (Office.context.mailbox.item.getAllInternetHeadersAsync) {
                    Office.context.mailbox.item.getAllInternetHeadersAsync(function(result) {
                        if (result.status === Office.AsyncResultStatus.Succeeded) {
                            var headers = parseHeaders(result.value);
                            resolve(headers);
                        } else {
                            console.warn("Unable to get real headers, using mock data");
                            resolve(getMockHeaders());
                        }
                    });
                } else {
                    console.warn("getAllInternetHeadersAsync not available, using mock data");
                    resolve(getMockHeaders());
                }
            });
        }

        function parseHeaders(headerString) {
            var headers = {};
            var lines = headerString.split('\n');
            for (var i = 0; i < lines.length; i++) {
                var line = lines[i].trim();
                if (line) {
                    var colonIndex = line.indexOf(':');
                    if (colonIndex > 0) {
                        var key = line.substring(0, colonIndex).trim();
                        var value = line.substring(colonIndex + 1).trim();
                        headers[key] = value;
                    }
                }
            }
            return headers;
        }

        function getMockHeaders() {
            return {
                "Authentication-Results": "spf=pass smtp.mailfrom=example.com; dkim=pass header.d=example.com; dmarc=pass",
                "Received-SPF": "pass (domain of example@example.com designates sender as permitted)",
                "DKIM-Signature": "v=1; a=rsa-sha256; d=example.com; s=default;"
            };
        }

        function checkSPF(headers) {
            var authResults = headers['Authentication-Results'] || '';
            var receivedSpf = headers['Received-SPF'] || '';
            
            var spfMatch = authResults.match(/spf=([^;\s]+)/i);
            var spfResult = spfMatch ? spfMatch[1].toLowerCase() : null;
            
            if (!spfResult && receivedSpf) {
                if (receivedSpf.toLowerCase().includes('pass')) spfResult = 'pass';
                else if (receivedSpf.toLowerCase().includes('fail')) spfResult = 'fail';
                else if (receivedSpf.toLowerCase().includes('neutral')) spfResult = 'neutral';
            }
            
            spfResult = spfResult || 'unknown';
            
            var details = '';
            if (spfResult === 'pass') details = 'Sender authorized for domain';
            else if (spfResult === 'fail') details = 'Sender NOT authorized';
            else if (spfResult === 'neutral') details = 'No SPF policy';
            else details = 'Status unknown';
            
            return {
                status: spfResult,
                pass: spfResult === 'pass',
                details: details
            };
        }

        function checkDKIM(headers) {
            var authResults = headers['Authentication-Results'] || '';
            var dkimSig = headers['DKIM-Signature'] || '';
            
            var dkimMatch = authResults.match(/dkim=([^;\s]+)/i);
            var dkimResult = dkimMatch ? dkimMatch[1].toLowerCase() : null;
            
            if (!dkimResult && dkimSig) {
                dkimResult = 'pass';
            }
            
            dkimResult = dkimResult || 'unknown';
            
            var details = '';
            if (dkimResult === 'pass') details = 'Digital signature valid';
            else if (dkimResult === 'fail') details = 'Signature verification failed';
            else details = 'Status unknown';
            
            return {
                status: dkimResult,
                pass: dkimResult === 'pass',
                details: details
            };
        }

        function checkDMARC(headers) {
            var authResults = headers['Authentication-Results'] || '';
            
            var dmarcMatch = authResults.match(/dmarc=([^;\s]+)/i);
            var dmarcResult = dmarcMatch ? dmarcMatch[1].toLowerCase() : 'unknown';
            
            var details = '';
            if (dmarcResult === 'pass') details = 'Policy alignment passed';
            else if (dmarcResult === 'fail') details = 'Policy failed - may be spoofed';
            else details = 'Status unknown';
            
            return {
                status: dmarcResult,
                pass: dmarcResult === 'pass',
                details: details
            };
        }

        function resetAuthenticationUI() {
            var checks = ['spf', 'dkim', 'dmarc'];
            
            for (var i = 0; i < checks.length; i++) {
                var check = checks[i];
                document.getElementById(check + '-icon').textContent = '⏳';
                document.getElementById(check + '-text').textContent = 'Checking...';
                document.getElementById(check + '-details').textContent = '';
                
                var statusElement = document.getElementById(check + '-status');
                statusElement.className = 'auth-status status-checking';
            }
            
            document.getElementById('score-number').textContent = '-';
            document.getElementById('security-recommendation').textContent = '';
        }

        function updateAuthenticationUI(type, result) {
            var iconElement = document.getElementById(type + '-icon');
            var textElement = document.getElementById(type + '-text');
            var detailsElement = document.getElementById(type + '-details');
            var statusElement = document.getElementById(type + '-status');
            
            if (result.pass) {
                iconElement.textContent = '✅';
                textElement.textContent = 'PASS';
                statusElement.className = 'auth-status status-pass';
            } else if (result.status === 'fail') {
                iconElement.textContent = '❌';
                textElement.textContent = 'FAIL';
                statusElement.className = 'auth-status status-fail';
            } else {
                iconElement.textContent = '⚠️';
                textElement.textContent = 'UNKNOWN';
                statusElement.className = 'auth-status status-warning';
            }
            
            detailsElement.textContent = result.details || '';
        }

        function calculateOverallScore(spfResult, dkimResult, dmarcResult) {
            var score = 0;
            
            if (spfResult.pass) score += 30;
            else if (spfResult.status === 'neutral') score += 15;
            
            if (dkimResult.pass) score += 35;
            
            if (dmarcResult.pass) score += 35;
            
            return Math.round(score);
        }

        function updateOverallScore(score) {
            document.getElementById('score-number').textContent = score;
            
            var recommendationElement = document.getElementById('security-recommendation');
            
            if (score >= 90) {
                recommendationElement.textContent = 'Excellent security!';
                recommendationElement.style.color = '#107c10';
            } else if (score >= 70) {
                recommendationElement.textContent = 'Good security';
                recommendationElement.style.color = '#ff8c00';
            } else if (score >= 40) {
                recommendationElement.textContent = 'Moderate security';
                recommendationElement.style.color = '#ff8c00';
            } else {
                recommendationElement.textContent = 'Poor security!';
                recommendationElement.style.color = '#d13438';
            }
        }

        function showError(message) {
            console.error(message);
            
            var checks = ['spf', 'dkim', 'dmarc'];
            for (var i = 0; i < checks.length; i++) {
                var check = checks[i];
                document.getElementById(check + '-icon').textContent = '❌';
                document.getElementById(check + '-text').textContent = 'Error';
                document.getElementById(check + '-details').textContent = message;
                
                var statusElement = document.getElementById(check + '-status');
                statusElement.className = 'auth-status status-fail';
            }
            
            document.getElementById('score-number').textContent = '?';
            document.getElementById('security-recommendation').textContent = 'Unable to check authentication.';
        }
    </script>
</body>
</html>
